<div class="row">
  <div class="col-md-12 stretch-card">
    <div class="card">
      <div class="card-body">
        <h6 class="card-title">Seguridad/Usuarios</h6>
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Eliminar</th>
                <th>Editar</th>
                <th>Editar Roles</th>
                <th>Asociar Roles</th>
                <th>User ID</th>
                <th>Nombre y Apellido</th>
                <th>E-mail</th>
                <th>Estatus</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let usuario of usuarios">
                <td>
                  <button class="btn btn-sm btn-danger" (click)="openEliminarModal(usuario, eliminarModal)">
                    <i class="mdi mdi-delete"></i>
                  </button>
                </td>
                <td>
                  <button class="btn btn-sm btn-primary" (click)="openEditarModal(usuario, editarModal)">
                    <i class="mdi mdi-pencil"></i>
                  </button>
                </td>
                <td>
                  <button class="btn btn-sm btn-info" (click)="openEditarRolesModal(usuario, editarRolesModal)">
                    <i class="mdi mdi-account-multiple"></i>
                  </button>
                </td>
                <td>
                  <button class="btn btn-sm btn-success" (click)="openAsociarRolesModal(usuario, asociarRolesModal)">
                    <i class="mdi mdi-account-plus"></i>
                  </button>
                </td>
                <td>{{ usuario.userId }}</td>
                <td>{{ usuario.nombre }} {{ usuario.apellido }}</td>
                <td>{{ usuario.email }}</td>
                <td>
                    <span class= "badge" [ngClass]= "usuario.estatus === 'activo' ? 'badge bg-success' : 'badge bg-danger'">
                    {{ usuario.estatus | titlecase }}
                    </span>
                </td>
              </tr>
            </tbody>
          </table>
          <div class="d-flex justify-content-start gap-3 mt-4">
          <button class="btn btn-secondary" (click)="regresar()">
            <i class="mdi mdi-arrow-left"></i> Regresar
          </button>
        </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal 1: Confirmar eliminación -->
<ng-template #eliminarModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Confirmar Eliminación</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.close()"></button>
  </div>
  <div class="modal-body text-center">
    <p>¿Está seguro que desea eliminar el usuario <strong>{{ usuarioSeleccionado?.userId }}</strong>?</p>
  </div>
  <div class="modal-footer">
    <button class="btn btn-danger" (click)="eliminarUsuario(usuarioSeleccionado!, eliminarModal)">Eliminar</button>
    <button class="btn btn-secondary" (click)="modal.close()">Cancelar</button>
  </div>
</ng-template>

<!-- Modal 2: Editar usuario -->
<ng-template #editarModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Editar Usuario</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.close()"></button>
  </div>
<form *ngIf="usuarioSeleccionado" (ngSubmit)="guardarEdicionUsuario(modal)">
  <div class="modal-body">
    <div class="mb-3">
      <label for="editUserId" class="form-label">User ID</label>
      <input id="editUserId" class="form-control" [(ngModel)]="usuarioSeleccionado.userId" name="editUserId" required readonly>
    </div>
    <div class="mb-3">
      <label for="editEstatus" class="form-label">Estatus</label>
      <select id="editEstatus" class="form-select" [(ngModel)]="usuarioSeleccionado.estatus" name="editEstatus" required>
        <option value="activo">Activo</option>
        <option value="inactivo">Inactivo</option>
      </select>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-success" type="submit">Guardar</button>
    <button class="btn btn-secondary" type="button" (click)="modal.close()">Salir</button>
  </div>
</form>
</ng-template>

<!-- Modal 3: Editar roles asociados -->
<ng-template #editarRolesModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Roles Asociados al Usuario: {{ usuarioSeleccionado?.nombre }} {{ usuarioSeleccionado?.apellido }}</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.close()"></button>
  </div>
  <div class="modal-body">
    <div class="table-responsive">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>ID</th>
            <th>Rol (Alias corto)</th>
            <th>Descripción</th>
            <th>Tipo</th>
            <th>Aplicación</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let rol of usuarioSeleccionado?.roles">
            <td>{{ rol.id }}</td>
            <td>{{ rol.alias }}</td>
            <td>{{ rol.descripcion }}</td>
            <td>{{ rol.tipo }}</td>
            <td>{{ rol.aplicacion }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" (click)="modal.close()">Salir</button>
  </div>
</ng-template>

<!-- Modal 4: Asociar roles -->
<ng-template #asociarRolesModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Asociar Roles a {{ usuarioSeleccionado?.nombre }} {{ usuarioSeleccionado?.apellido }}</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.close()"></button>
  </div>
  <div class="modal-body">
    <div class="mb-3">
      <strong>Usuario:</strong> {{ usuarioSeleccionado?.nombre }} {{ usuarioSeleccionado?.apellido }}
    </div>
    <div class="table-responsive">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Seleccionar</th>
            <th>Rol (Alias corto)</th>
            <th>Descripción</th>
            <th>Aplicación</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let rol of rolesDisponibles; let i = index">
            <td>
              <div class="form-check">
                <input class="form-check-input"
                       type="checkbox"
                       [(ngModel)]="rol.seleccionado"
                       [name]="'rolSeleccionado' + i"
                       [id]="'rolSeleccionado' + i">
                <label class="form-check-label" [for]="'rolSeleccionado' + i"></label>
              </div>
            </td>
            <td>{{ rol.alias }}</td>
            <td>{{ rol.descripcion }}</td>
            <td>{{ rol.aplicacion }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-success" (click)="guardarAsociacionRoles(usuarioSeleccionado!, modal)">Guardar</button>
    <button class="btn btn-secondary" (click)="modal.close()">Salir</button>
  </div>
</ng-template>