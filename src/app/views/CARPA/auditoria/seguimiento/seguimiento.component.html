<div class="card">
		<div class="card-header d-flex justify-content-between align-items-center">
			<h6 class="card-title fw-semibold">Auditoría / Seguimiento</h6>
			<button *ngIf="!viewFiltro" class="btn btn-outline-secondary volver" (click)="regresarAFiltro()">
				<i class="icon-bdv-icon-back-m me-2" aria-hidden="true"></i>Volver
			</button>

	</div>
	<div class="card-body">
		<app-local-loading [loading]="loading"></app-local-loading>

		<!-- VISTA 1: FORMULARIO DE FILTRO -->
		<div *ngIf="viewFiltro">
			<div class="d-flex flex-column align-items-center">
				<div class="col-12 col-md-4 mb-3">
					<label class="form-label">Aplicación</label>
					<select class="form-select" [(ngModel)]="filtro.aplicacion">
						<option [ngValue]="null">Seleccione</option>
						<option *ngFor="let a of aplicaciones" [ngValue]="a.siglasApplic">{{ a.siglasApplic }}</option>
					</select>
				</div>

				<div class="col-12 col-md-4 mb-3">
					<label class="form-label">Fecha</label>
					<div class="input-group">
						<input class="form-control" placeholder="AAAA-MM-DD" name="d" [(ngModel)]="filtro.fecha"
							ngbDatepicker #d="ngbDatepicker">
						<button class="btn btn-outline-secondary" type="button" (click)="d.toggle()"><i
								class="feather icon-calendar"></i></button>
					</div>
				</div>

				<div class="col-12 my-4 d-flex gap-2 justify-content-center">
					<button class="btn btn-primary" (click)="consultar()">Consultar</button>
					<!-- <button class="btn btn-secondary"
						(click)="filtro = { aplicacion: null, fecha: null }">Limpiar</button> -->
				</div>
			</div>
		</div>

		<!-- VISTA 2: RESULTADOS -->
		<div *ngIf="!viewFiltro">
			<div class="">
				<div class="d-flex  justify-content-end mb-3">
				<strong>Total:&nbsp;</strong>{{ logsFiltrados.length }}
			</div>
				   <div class="d-flex justify-content-between align-items-center mb-4 gap-2">
					   <!-- <button class="btn btn-success" (click)="exportCsv()"><i class="feather icon-download"></i>
						   Exportar</button> -->
					   <select class="form-select" style="width:150px;" [(ngModel)]="statusFiltro" (change)="filtrarPorStatus()">
						   <option [ngValue]="null">Todos</option>
						   <option value="200">OK</option>
						   <option value="PROCESSING">Procesando</option>
						   <option value="ERROR">Error</option>
						   <option value="INFO">Info</option>
						   <option value="WARN">Warn</option>
					   </select>
					   <input class="form-control" style="width:260px;" placeholder="Buscar..." [(ngModel)]="searchTerm"
						   (input)="filtrarBusqueda()">
				   </div>
			</div>

									<div class="row g-3 justify-content-center">
										<ng-container *ngFor="let l of logsPaginados">
											<div class="col-12 col-md-8 col-lg-6">
												<div class="card h-100 shadow log-card border-0" style="background: #f8fafc; max-width: 480px; margin: 0 auto;">
													<div class="card-body p-3">
														<div class="d-flex justify-content-between align-items-center mb-2">
															<div class="d-flex align-items-center gap-2">
																<span class="rounded-circle d-flex align-items-center justify-content-center" style="width:32px;height:32px;background:#e3eafc;">
																	<i class="mdi mdi-file-document-outline text-primary fs-4"></i>
																</span>
																<span class="fw-semibold text-primary">{{ l.source }}</span>
															</div>
															<span class="text-muted small"><i class="mdi mdi-calendar-clock me-1"></i>{{ l.timestamp }}</span>
														</div>
														<div class="mb-2">
															<span class="badge px-3 py-1" [ngClass]="{
																'bg-success': l.status === 'completed',
																'bg-danger': l.status === 'error',
																'bg-info': !l.status || l.status === 'in-progress'
															}">
																<i class="mdi" [ngClass]="{
																	'mdi-check-circle': l.status === 'completed',
																	'mdi-alert-circle': l.status === 'error',
																	'mdi-progress-clock': !l.status || l.status === 'in-progress'
																}"></i>
																{{ l.status ? l.status : 'Log' }}
															</span>
														</div>
														<div class="mb-2">
															<span *ngIf="l.statusLabel" class="badge px-2 py-1 mb-1"
																[ngClass]="{
																	'bg-warning ': l.statusLabel.type === 'warning',
																	'bg-success': l.statusLabel.type === 'success',
																	'bg-danger': l.statusLabel.type === 'danger',
																	'bg-info': l.statusLabel.type === 'info',
																	'bg-secondary': l.statusLabel.type === 'secondary',
																	'bg-primary': l.statusLabel.type === 'primary'
																}">
																{{ l.statusLabel.text }}
															</span><br>
															<strong class="text-dark">Aplicación:</strong>
															<span class="text-primary fw-semibold">{{ l.aplicacion }}</span>
														</div>
														<div class="mb-2">
															<strong class="text-dark">Mensaje:</strong>
															<span class="d-block text-break" style="font-size:1.05em; color:#374151;">{{ l.message }}</span>
														</div>
														<div class="mb-2 text-center">
															<button class="btn btn-outline-primary btn-sm px-3" style="min-width:120px;" (click)="openViewModal(viewModal, l)">
																<i class="mdi mdi-eye-outline me-1"></i> Ver detalle
															</button>
														</div>
													</div>
												</div>
											</div>
										</ng-container>
									</div>

			<!-- Paginación -->
			<div class="d-flex justify-content-between align-items-center mt-3">
				<div class="d-flex align-items-center gap-2">
					<select class="form-select" style="width:auto;display:inline-block" [(ngModel)]="pageSize"
						(change)="cambiarPageSize(pageSize)">
						<option [ngValue]="5">5</option>
						<option [ngValue]="10">10</option>
						<option [ngValue]="25">25</option>
					</select>
					<label class="me-2 mb-0">registros por página</label>
				</div>
				<ul class="pagination mb-0">
					<li class="page-item" [class.disabled]="page === 1"><button class="page-link"
							(click)="cambiarPagina(page - 1)">Anterior</button></li>
					<li class="page-item" [class.active]="page === 1"><button class="page-link"
							(click)="cambiarPagina(1)">1</button></li>
					<ng-container *ngFor="let p of [page-2, page-1, page, page+1, page+2]">
						<li class="page-item" *ngIf="p > 1 && p < totalPages" [class.active]="page === p"><button
								class="page-link" (click)="cambiarPagina(p)">{{ p }}</button></li>
					</ng-container>
					<li class="page-item" [class.disabled]="page === totalPages"><button class="page-link"
							(click)="cambiarPagina(page + 1)">Siguiente</button></li>
				</ul>
			</div>
		</div>

	</div>
</div>

<!-- Modal de detalle (se mantiene) -->
<ng-template #viewModal let-modal>
	<div class="modal-header">
		<h5 class="modal-title">Detalle del log</h5>
		<button type="button" class="btn-close" aria-label="Close" (click)="modal.close()"></button>
	</div>
	<div class="modal-body">
		<div *ngIf="selectedLog">
			<p><strong>ID:</strong> {{ selectedLog.id }}</p>
			<p><strong>Fecha:</strong> {{ selectedLog.timestamp }}</p>
			<p><strong>Origen:</strong> {{ selectedLog.source }}</p>
			<p><strong>Mensaje:</strong> {{ selectedLog.message }}</p>
			<p><strong>Estado:</strong> {{ selectedLog.status }}</p>
			<hr>
			<pre style="white-space:pre-wrap">{{ selectedLog.details }}</pre>
		</div>
	</div>
	<div class="modal-footer">
		<button class="btn btn-secondary" (click)="modal.close()">Cerrar</button>
	</div>
</ng-template>