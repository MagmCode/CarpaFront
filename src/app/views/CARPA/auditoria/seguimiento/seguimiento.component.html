<div class="card">
		<div class="card-header d-flex justify-content-between align-items-center">
			<h6 class="card-title fw-semibold">Auditoría / Seguimiento</h6>
			<button *ngIf="!viewFiltro" class="btn btn-outline-secondary volver" (click)="regresarAFiltro()">
				<i class="icon-bdv-icon-back-m me-2" aria-hidden="true"></i>Volver
			</button>

	</div>
	<div class="card-body">

		<!-- VISTA 1: FORMULARIO DE FILTRO -->
		<div *ngIf="viewFiltro">
			<div class="d-flex flex-column align-items-center">
				<div class="col-12 col-md-4 mb-3">
					<label class="form-label">Aplicación</label>
					<select class="form-select" [(ngModel)]="filtro.aplicacion">
						<option [ngValue]="null">Todas</option>
						<option *ngFor="let a of aplicaciones" [ngValue]="a.id">{{ a.nombre }}</option>
					</select>
				</div>

				<div class="col-12 col-md-4 mb-3">
					<label class="form-label">Fecha</label>
					<div class="input-group">
						<input class="form-control" placeholder="AAAA-MM-DD" name="d" [(ngModel)]="filtro.fecha"
							ngbDatepicker #d="ngbDatepicker">
						<button class="btn btn-outline-secondary" type="button" (click)="d.toggle()"><i
								class="feather icon-calendar"></i></button>
					</div>
				</div>

				<div class="col-12 my-4 d-flex gap-2 justify-content-center">
					<button class="btn btn-primary" (click)="consultar()">Consultar</button>
					<!-- <button class="btn btn-secondary"
						(click)="filtro = { aplicacion: null, fecha: null }">Limpiar</button> -->
				</div>
			</div>
		</div>

		<!-- VISTA 2: RESULTADOS -->
		<div *ngIf="!viewFiltro">
			<div class="">
				<div class="d-flex  justify-content-end mb-3">
				<strong>Total:&nbsp;</strong>{{ logsFiltrados.length }}
			</div>
				   <div class="d-flex justify-content-between align-items-center mb-4 gap-2">
					   <!-- <button class="btn btn-success" (click)="exportCsv()"><i class="feather icon-download"></i>
						   Exportar</button> -->
					   <select class="form-select" style="width:150px;" [(ngModel)]="statusFiltro" (change)="filtrarPorStatus()">
						   <option [ngValue]="null">Todos</option>
						   <option value="completed">Completado</option>
						   <option value="error">Error</option>
						   <option value="in-progress">En progreso</option>
					   </select>
					   <input class="form-control" style="width:260px;" placeholder="Buscar..." [(ngModel)]="searchTerm"
						   (input)="filtrarBusqueda()">
				   </div>
			</div>

									<div class="row g-3">
										<ng-container *ngFor="let l of logsPaginados">
															<div class="col-12">
																<div class="card h-100 shadow-sm border-primary log-card">
													<div class="card-body">
														<div class="d-flex justify-content-between align-items-center mb-2">
															<span class="badge"
																[ngClass]="l.status === 'completed' ? 'bg-success' : (l.status === 'error' ? 'bg-danger' : 'bg-info')">{{ l.status }}</span>
															<span class="text-muted small">{{ l.timestamp }}</span>
														</div>
														<h6 class="card-title mb-1">{{ l.source }}</h6>
														<div class="mb-2 text-truncate" style="max-width:100%"><strong>Mensaje:</strong> {{ l.message }}</div>
														<div class="mb-2"><strong>Aplicación:</strong> {{ l.aplicacion }}</div>
														<button class="btn btn-outline-primary btn-sm w-100" (click)="openViewModal(viewModal, l)"><i class="feather icon-eye"></i> Ver detalle</button>
													</div>
												</div>
											</div>
										</ng-container>
									</div>

			<!-- Paginación -->
			<div class="d-flex justify-content-between align-items-center mt-3">
				<div class="d-flex align-items-center gap-2">
					<select class="form-select" style="width:auto;display:inline-block" [(ngModel)]="pageSize"
						(change)="cambiarPageSize(pageSize)">
						<option [ngValue]="5">5</option>
						<option [ngValue]="10">10</option>
						<option [ngValue]="25">25</option>
					</select>
					<label class="me-2 mb-0">registros por página</label>
				</div>
				<ul class="pagination mb-0">
					<li class="page-item" [class.disabled]="page === 1"><button class="page-link"
							(click)="cambiarPagina(page - 1)">Anterior</button></li>
					<li class="page-item" [class.active]="page === 1"><button class="page-link"
							(click)="cambiarPagina(1)">1</button></li>
					<ng-container *ngFor="let p of [page-2, page-1, page, page+1, page+2]">
						<li class="page-item" *ngIf="p > 1 && p < totalPages" [class.active]="page === p"><button
								class="page-link" (click)="cambiarPagina(p)">{{ p }}</button></li>
					</ng-container>
					<li class="page-item" [class.disabled]="page === totalPages"><button class="page-link"
							(click)="cambiarPagina(page + 1)">Siguiente</button></li>
				</ul>
			</div>
		</div>

	</div>
</div>

<!-- Modal de detalle (se mantiene) -->
<ng-template #viewModal let-modal>
	<div class="modal-header">
		<h5 class="modal-title">Detalle del log</h5>
		<button type="button" class="btn-close" aria-label="Close" (click)="modal.close()"></button>
	</div>
	<div class="modal-body">
		<div *ngIf="selectedLog">
			<p><strong>ID:</strong> {{ selectedLog.id }}</p>
			<p><strong>Fecha:</strong> {{ selectedLog.timestamp }}</p>
			<p><strong>Origen:</strong> {{ selectedLog.source }}</p>
			<p><strong>Mensaje:</strong> {{ selectedLog.message }}</p>
			<p><strong>Estado:</strong> {{ selectedLog.status }}</p>
			<hr>
			<pre style="white-space:pre-wrap">{{ selectedLog.details }}</pre>
		</div>
	</div>
	<div class="modal-footer">
		<button class="btn btn-secondary" (click)="modal.close()">Cerrar</button>
	</div>
</ng-template>